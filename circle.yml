machine:
#  environment:
#    XCODE_SCHEME: ChatLocal
#  xcode:
#    version: 7.2
  node:
    version: 5.1.0

dependencies:
  override:
    - rm -rf node_modules
    - npm uninstall -g react-native-cli
    - npm install
    - npm install -g react-native-cli
    - sudo pip install awscli

test:
  override:
    - npm test
    - mkdir ios.bundle
    - react-native bundle --minify --dev false --entry-file index.ios.js --platform ios --assets-dest ios.bundle --bundle-output ios.bundle/main.jsbundle
    - zip -r ios.bundle.zip ios.bundle
    - npm run sign ios.bundle.zip
    - zip main.zip ios.bundle.zip  signature.txt

deployment:
  production:
    branch:  /release_v.*/
    commands:
      - aws s3 cp main.zip s3://rn-chat/ios_$CIRCLE_BRANCH.zip --acl public-read

    branch:  /v.*/
    commands:
      - aws s3 cp main.zip s3://rn-chat/ios_release_$CIRCLE_BRANCH.zip --acl public-read